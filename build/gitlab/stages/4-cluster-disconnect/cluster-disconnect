#!/bin/bash

time="$(TZ=IST date)"
current_time=$time
echo $current_time
path=$(pwd)

printf "***Checking if the cluster is ready to disconnect*****\n\n"

##Checking if the cluster is ready to disconnect
sleep 15
litmus_ns="sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port 'kubectl get ns litmus --no-headers | awk '{print $1}''"
if [ -n "$litmus_ns" ]; then
  echo "Please Delete Litmus Namespace"
  exit 1;
fi

#Checking Cluster's Health 
echo "*****************************Checking the Cluster's Health*************************"
echo "************    Checking for the number of nodes in ready state      **************"

##Number of nodes in the cluster
ready_nodes=$(sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port kubectl get nodes --no-headers | grep -v NotReady | wc -l)
echo "Number of nodes in ready state is $ready_nodes"
if [ "$ready_nodes" -eq 4 ]; then
    printf "Cluster is up and running with $ready_nodes nodes\n"
else
echo "Cluster is not Healthy"
exit 1;
fi

#Removing the litmus cloned directory
echo "Removing the litmus cloned directory"
sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port 'rm -rf /home/udit/go/src/github.com/litmuschaos/litmus-e2e'