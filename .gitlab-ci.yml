---
stages:
  - setup
  - install
  - deploy
  - Generic Experiment
  - Infra Experiment
  - Component Checks
  - Ansible Experiment 
  - E2E Metrics
  - App Cleanup
  - Cleanup

EKS Setup:
  stage: setup
  tags:
    - litmus-build
  script:
    - chmod 755 build/gitlab/eks/1-cluster-setup/setup
    - ./build/eks/gitlab/1-cluster-setup/setup
  artifacts:
    when: always
    paths:
      - .kube/
      

Litmus Infra Setup:
  when: always
  stage: install
  tags:
    - litmus-build
  script:
    - make build-litmus
  artifacts:
    when: always
    paths:
      - .kube/    
Deploy App:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: deploy
  tags:
    - litmus-build
  script:
    - make app-deploy
  artifacts:
    when: always
    paths:
      - .kube/

Liveness:
  when: always
  stage: deploy
  tags:
    - litmus-build
  script:
    - make liveness
  artifacts:
    when: always
    paths:
      - .kube/

Auxiliary App:
  when: always
  stage: deploy
  tags:
    - litmus-build
  script:
    - make auxiliary-app
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-DELETE:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-delete
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-CONTAINER-KILL:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make container-kill
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-CPU-HOG:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-MEMORY-HOG:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-NETWORK-CORRUPTION:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-network-corruption
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-NETWORK-LATENCY:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-network-latency
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-NETWORK-LOSS:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-network-loss
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-APP-POD-NETWORK-DUPLICATION:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-network-duplication
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-EKS-GENERIC-APP-POD-IO-STRESS:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-io-stress
  artifacts:
    when: always
    paths:
      - .kube/ 
      
TCID-EKS-GENERIC-APP-POD-AUTOSCALER:
  when: always
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-autoscaler
  artifacts:
    when: always
    paths:
      - .kube/       

TCID-EKS-GENERIC-APP-DISK-FILL:
  when: always
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make disk-fill
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-INFRA-NODE-CPU-HOG:
  when: always
  stage: Infra Experiment
  tags: 
    - litmus-build
  script:
    - make node-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/      

TCID-EKS-GENERIC-INFRA-NODE-MEMORY-HOG:
  when: always
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-INFRA-NODE-DRAIN:
  when: always
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-drain
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-INFRA-KUBELET-SERVICE-KILL:
  when: always
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make kubelet-service-kill
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-EKS-GENERIC-INFRA-NODE-TAINT:
  when: always
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-taint
  artifacts:
    when: always
    paths:
      - .kube/
      
TCID-EKS-GENERIC-INFRA-NODE-IO-STRESS:
  when: always
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-io-stress
  artifacts:
    when: always
    paths:
      - .kube/       

TCID-EKS-GENERIC-OPERATOR-RECONCILE-RESILIENCY:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make operator-reconcile-resiliency-check
  artifacts:
    when: always
    paths:
      - .kube/      

TCID-EKS-GENERIC-OPERATOR-ADMIN-MODE:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make admin-mode-check
  artifacts:
    when: always
    paths:
      - .kube/
      
TCID-EKS-GENERIC-ENGINE-APP-INFO:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make appinfo
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-ENGINE-ANNOTATION-CHECK:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make annotation-check
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-ENGINE-ENGINE-STATE:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make engine-state
  artifacts:
    when: always
    paths:
      - .kube/

TCID-EKS-GENERIC-ENGINE-EXPERIMENT-NAME:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make experiment-404
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-EKS-GENERIC-ENGINE-JOB-CLEANUP-POLICY:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make job-cleanup-policy
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-EKS-GENERIC-ENGINE-SERVICE-ACCOUNT:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make service-account
  artifacts:
    when: always
    paths:
      - .kube/
      
TCID-EKS-GENERIC-EXPERIMENT-EXPERIMENT-IMAGE-NAME:
  when: always
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make experiment-image
  artifacts:
    when: always
    paths:
      - .kube/        

## Ansible Experiments will trigger 
## only if ANSIBLE_JOB is defined

TCID-EKS-ANSIBLE-APP-POD-DELETE:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-pod-delete
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-APP-CONTAINER-KILL:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-container-kill
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-APP-DISK-FILL:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-disk-fill
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"       

TCID-EKS-ANSIBLE-INFRA-NODE-CPU-HOG:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-INFRA-NODE-MEMORY-HOG:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true" 

TCID-EKS-ANSIBLE-APP-POD-CPU-HOG:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-pod-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-APP-POD-MEMORY-HOG:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-pod-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-APP-POD-NETWORK-CORRUPTION:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-pod-network-corruption
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-APP-POD-NETWORK-LATENCY:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-pod-network-latency
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"   

TCID-EKS-ANSIBLE-APP-POD-NETWORK-LOSS:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-pod-network-loss
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-EKS-ANSIBLE-INFRA-KUBELET-SERVICE-KILL:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-kubelet-service-kill
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"
    
TCID-EKS-ANSIBLE-INFRA-NODE-DRAIN:
  when: always
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-drain
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"     

E2E Metrics:
  when: always
  stage: E2E Metrics
  tags:
    - litmus-build
  script:
    - make e2e-metrics
  artifacts:
    when: always
    paths:
      - .kube/

App Cleanup:
  when: always
  stage: App Cleanup
  tags: 
    - litmus-build
  script:
    - make app-cleanup 
  artifacts:
    when: always
    paths:
      - .kube/

Pipeline Status Check:
  when: always
  stage: App Cleanup
  tags:
    - litmus-build
  script:
    - make pipeline-status-update
  artifacts:
    when: always
    paths:
      - .kube/
      
EKS Cleanup:
  when: always
  stage: Cleanup
  tags:
    - litmus-build
  script:
    - chmod 755 build/gitlab/eks/2-cluster-cleanup/cleanup
    - ./build/eks/gitlab/2-cluster-cleanup/cleanup
  artifacts:
    when: always
    paths:
      - .kube/
