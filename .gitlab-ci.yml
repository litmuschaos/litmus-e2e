---
stages:
  - setup
  - install
  - deploy
  - Generic Experiment
  - Infra Experiment
  - Component Checks
  - Ansible Experiment 
  - E2E Metrics
  - App Cleanup
  - Cleanup

image: ${IMAGE_TO_RUN_JOBS}

before_script:
  - mkdir -p ${GOPATH}/src/github.com/litmuschaos/litmus-e2e
  - rsync -az --delete ${CI_PROJECT_DIR}/ ${GOPATH}/src/github.com/litmuschaos/litmus-e2e
  - cd ${GOPATH}/src/github.com/litmuschaos/litmus-e2e
  - kubectl get nodes

include:
  - local: '/templates/.pod-level-test-template.yml'
  - local: '/templates/.component-test-template.yml'

TCID-VMWx-GENERIC-APP-POD-AUTOSCALER:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-autoscaler
  artifacts:
    when: always
    paths:
      - .kube/ 
  only:
    variables:
    - $NODE_LEVEL == "true"                

TCID-VMWx-GENERIC-INFRA-NODE-CPU-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags: 
    - litmus-build
  script:
    - make node-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"                

TCID-VMWx-GENERIC-INFRA-NODE-MEMORY-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"          

TCID-VMWx-GENERIC-INFRA-NODE-DRAIN:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-drain
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"          

TCID-VMWx-GENERIC-INFRA-KUBELET-SERVICE-KILL:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make kubelet-service-kill
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"           

TCID-VMWx-GENERIC-INFRA-NODE-TAINT:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-taint
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"          
      
TCID-VMWx-GENERIC-INFRA-NODE-IO-STRESS:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-io-stress
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"                 

TCID-VMWx-ANSIBLE-INFRA-NODE-CPU-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL_ANSIBLE_JOB == "true"

TCID-VMWx-ANSIBLE-INFRA-NODE-MEMORY-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL_ANSIBLE_JOB == "true" 

TCID-VMWx-ANSIBLE-INFRA-KUBELET-SERVICE-KILL:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-kubelet-service-kill
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL_ANSIBLE_JOB == "true"
    
TCID-VMWx-ANSIBLE-INFRA-NODE-DRAIN:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-drain
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL_ANSIBLE_JOB == "true"     

E2E Metrics In Cluster-2:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: E2E Metrics
  tags:
    - litmus-build
  script:
    - make e2e-metrics
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"       

App Cleanup In Cluster-2:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: App Cleanup
  tags: 
    - litmus-build
  script:
    - make app-cleanup 
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"       

Pipeline Status Check In Cluster-2:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: App Cleanup
  tags:
    - litmus-build
  script:
    - make pipeline-status-update
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $NODE_LEVEL == "true"       
