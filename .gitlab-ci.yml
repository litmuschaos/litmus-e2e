---
stages:
  - setup
  - install
  - deploy
  - generic-experiment
  - infra-experiment
  - push
  - app-cleanup
  - cleanup

.before_script_template:
  before_script:

    - sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port 'export GOPATH=$HOME/go'
    - sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port 'pwd'
    - sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port 'ls'
    - sshpass -p $pass ssh -o StrictHostKeyChecking=no $user@$ip -p $port 'export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin'

# Cluster Setup:

#   stage: setup
#   tags:
#     - litmus-build
#   script: 
#     - chmod 755 ./build/gitlab/stages/1-gke-setup/cluster-setup
#     - ./build/gitlab/stages/1-gke-setup/cluster-setup

#   artifacts:
#     when: always
#     paths:
#       - .kube/

Cluster Connect:

  stage: setup
  tags:
    - litmus-build
  script: 
    - chmod 755 ./build/gitlab/stages/3-cluster-connect/cluster-connect
    - ./build/gitlab/stages/3-cluster-connect/cluster-connect

  artifacts:
    when: always
    paths:
      - .kube/

Litmus Infra Setup:

  when: always
  image: litmuschaos/litmus-e2e:latest
  extends: .before_script_template
  stage: install
  tags:
    - litmus-build
  script:
    - make build-litmus

  artifacts:
    when: always
    paths:
      - .kube/
    
Deploy App:

  when: always
  image: litmuschaos/litmus-e2e:latest
  extends: .before_script_template
  stage: deploy
  tags:
    - litmus-build
  script:
    - make app-deploy 

  artifacts:
    when: always
    paths:
      - .kube/

Liveness:

  when: always
  image: litmuschaos/litmus-e2e:latest
  extends: .before_script_template
  stage: deploy
  tags:
    - litmus-build
  script:
    - make liveness

  artifacts:
    when: always
    paths:
      - .kube/

Auxiliary App:

  when: always
  image: litmuschaos/litmus-e2e:latest
  extends: .before_script_template
  stage: deploy
  tags:
    - litmus-build
  script:
    - make auxiliary-app

  artifacts:
    when: always
    paths:
      - .kube/

pod-delete:

  when: always
  image: litmuschaos/litmus-e2e:latest
  extends: .before_script_template
  stage: generic-experiment
  tags:
    - litmus-build
  script:
    - make pod-delete

  artifacts:
    when: always
    paths:
      - .kube/

container-kill:

  when: always
  image: litmuschaos/litmus-e2e:latest
  extends: .before_script_template
  stage: generic-experiment
  tags:
    - litmus-build
  script:
    - make container-kill

  artifacts:
    when: always
    paths:
      - .kube/

pod-network-latency:

  when: always
  extends: .before_script_template
  stage: generic-experiment
  tags:
    - litmus-build
  script:
    - make pod-network-latency

  artifacts:
    when: always
    paths:
      - .kube/

pod-network-loss:

  when: always
  extends: .before_script_template
  stage: generic-experiment
  tags:
    - litmus-build
  script:
    - make pod-network-loss

  artifacts:
    when: always
    paths:
      - .kube/

pod-network-corruption:

  when: always
  extends: .before_script_template
  stage: generic-experiment
  tags:
    - litmus-build
  script:
    - make pod-network-corruption

  artifacts:
    when: always
    paths:
      - .kube/

pod-cpu-hog:

  when: always
  extends: .before_script_template
  stage: generic-experiment
  tags:
    - litmus-build
  script:
    - make pod-cpu-hog

  artifacts:
    when: always
    paths:
      - .kube/

node-cpu-hog:

  extends: .before_script_template
  when: always
  stage: infra-experiment
  tags: 
    - litmus-build
  script:
    - make node-cpu-hog

node-drain:

  extends: .before_script_template
  when: always
  stage: infra-experiment
  tags:
    - litmus-build
  script:
    - make node-drain

  artifacts:
    when: always
    paths:
      - .kube/

disk-fill:

  extends: .before_script_template
  when: always
  stage: infra-experiment
  tags:
    - litmus-build
  script:
    - make disk-fill

  artifacts:
    when: always
    paths:
      - .kube/

node-memory-hog:

  extends: .before_script_template
  when: always
  stage: infra-experiment
  tags:
    - litmus-build
  script:
    - make node-memory-hog

  artifacts:
    when: always
    paths:
      - .kube/      

App Cleanup:

  extends: .before_script_template
  when: always
  stage: app-cleanup
  tags: 
    - litmus-build
  script:
    - make app-cleanup
    
  artifacts:
    when: always
    paths:
      - .kube/

Cluster Disconnect:

  when: always
  stage: cleanup
  tags:
    - litmus-build
  script: 
    - chmod 755 ./build/gitlab/stages/4-cluster-disconnect/cluster-disconnect
    - ./build/gitlab/stages/4-cluster-disconnect/cluster-disconnect

  artifacts:
    when: always
    paths:
      - .kube/

# Cluster Cleanup:

#   when: always
#   stage: cleanup
#   tags:
#     - litmus-build
#   script: 
#     - chmod 755 ./build/gitlab/stages/2-gke-cleanup/cluster-cleanup
#     - ./build/gitlab/stages/2-gke-cleanup/cluster-cleanup

#   artifacts:
#     when: always
#     paths:
#       - .kube/