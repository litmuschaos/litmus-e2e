---
stages:
  - setup
  - install
  - deploy
  - Generic Experiment
  - Infra Experiment
  - Component Checks
  - Ansible Experiment 
  - E2E Metrics
  - App Cleanup
  - Cleanup

include:
  - local: '/templates/.pod-level-test-template.yml'

Cluster Connect:
  image: litmuschaos/litmus-e2e:latest
  stage: setup
  tags:
    - litmus-build
  script: 
    - chmod 755 ./build/gitlab/stages/3-cluster-connect/cluster-connect
    - ./build/gitlab/stages/3-cluster-connect/cluster-connect
  artifacts:
    when: always
    paths:
      - .kube/

Litmus Infra Setup:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: install
  tags:
    - litmus-build
  script:
    - make build-litmus
  artifacts:
    when: always
    paths:
      - .kube/      

Deploy App:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: deploy
  tags:
    - litmus-build
  script:
    - make app-deploy
  artifacts:
    when: always
    paths:
      - .kube/

Liveness:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: deploy
  tags:
    - litmus-build
  script:
    - make liveness
  artifacts:
    when: always
    paths:
      - .kube/    

Auxiliary App:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: deploy
  tags:
    - litmus-build
  script:
    - make auxiliary-app
  artifacts:
    when: always
    paths:
      - .kube/

TCID-VMWx-GENERIC-APP-POD-AUTOSCALER:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Generic Experiment
  tags:
    - litmus-build
  script:
    - make pod-autoscaler
  artifacts:
    when: always
    paths:
      - .kube/       

TCID-VMWx-GENERIC-INFRA-NODE-CPU-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags: 
    - litmus-build
  script:
    - make node-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/      

TCID-VMWx-GENERIC-INFRA-NODE-MEMORY-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/

TCID-VMWx-GENERIC-INFRA-NODE-DRAIN:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-drain
  artifacts:
    when: always
    paths:
      - .kube/

TCID-VMWx-GENERIC-INFRA-KUBELET-SERVICE-KILL:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make kubelet-service-kill
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-VMWx-GENERIC-INFRA-NODE-TAINT:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-taint
  artifacts:
    when: always
    paths:
      - .kube/
      
TCID-VMWx-GENERIC-INFRA-NODE-IO-STRESS:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Infra Experiment
  tags:
    - litmus-build
  script:
    - make node-io-stress
  artifacts:
    when: always
    paths:
      - .kube/       

TCID-VMWx-GENERIC-OPERATOR-RECONCILE-RESILIENCY:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make operator-reconcile-resiliency-check
  artifacts:
    when: always
    paths:
      - .kube/      

TCID-VMWx-GENERIC-OPERATOR-ADMIN-MODE:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make admin-mode-check
  artifacts:
    when: always
    paths:
      - .kube/
      
TCID-VMWx-GENERIC-ENGINE-APP-INFO:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make appinfo
  artifacts:
    when: always
    paths:
      - .kube/

TCID-VMWx-GENERIC-ENGINE-ANNOTATION-CHECK:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make annotation-check
  artifacts:
    when: always
    paths:
      - .kube/

TCID-VMWx-GENERIC-ENGINE-ENGINE-STATE:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make engine-state
  artifacts:
    when: always
    paths:
      - .kube/

TCID-VMWx-GENERIC-ENGINE-EXPERIMENT-NAME:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make experiment-404
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-VMWx-GENERIC-ENGINE-JOB-CLEANUP-POLICY:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make job-cleanup-policy
  artifacts:
    when: always
    paths:
      - .kube/ 

TCID-VMWx-GENERIC-ENGINE-SERVICE-ACCOUNT:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make service-account
  artifacts:
    when: always
    paths:
      - .kube/
      
TCID-VMWx-GENERIC-EXPERIMENT-EXPERIMENT-IMAGE-NAME:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make experiment-image
  artifacts:
    when: always
    paths:
      - .kube/ 
      
TCID-VMWx-GENERIC-EXPERIMENT-TARGET-POD:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Component Checks
  tags:
    - litmus-build
  script:
    - make target-pod
  artifacts:
    when: always
    paths:
      - .kube/    

TCID-VMWx-ANSIBLE-INFRA-NODE-CPU-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-cpu-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"

TCID-VMWx-ANSIBLE-INFRA-NODE-MEMORY-HOG:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-memory-hog
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true" 

TCID-VMWx-ANSIBLE-INFRA-KUBELET-SERVICE-KILL:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-kubelet-service-kill
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"
    
TCID-VMWx-ANSIBLE-INFRA-NODE-DRAIN:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Ansible Experiment 
  tags:
    - litmus-build
  script:
    - make ansible-node-drain
  artifacts:
    when: always
    paths:
      - .kube/
  only:
    variables:
    - $ANSIBLE_JOB == "true"     

E2E Metrics:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: E2E Metrics
  tags:
    - litmus-build
  script:
    - make e2e-metrics
  artifacts:
    when: always
    paths:
      - .kube/

App Cleanup:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: App Cleanup
  tags: 
    - litmus-build
  script:
    - make app-cleanup 
  artifacts:
    when: always
    paths:
      - .kube/

Pipeline Status Check:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: App Cleanup
  tags:
    - litmus-build
  script:
    - make pipeline-status-update
  artifacts:
    when: always
    paths:
      - .kube/
      
Cluster Disconnect:
  when: always
  image: litmuschaos/litmus-e2e:latest
  stage: Cleanup
  tags:
    - litmus-build
  script: 
    - chmod 755 ./build/gitlab/stages/4-cluster-disconnect/cluster-disconnect
    - ./build/gitlab/stages/4-cluster-disconnect/cluster-disconnect
  artifacts:
    when: always
    paths:
      - .kube/
  