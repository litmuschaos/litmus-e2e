---
stages:

  - cluster setup
  - Infra setup
  - experiment
  - Infra cleanup
  - cluster cleanup

Cluster Setup:

  stage: cluster setup
  tags:
    - setup
  script: 
    - chmod 755 ./build/gitlab/stages/1-gke-setup/cluster-setup
    - ./build/gitlab/stages/1-gke-setup/cluster-setup

  artifacts:
    when: always
    paths:
      - .kube/

Build Litmus:

  when: always
  stage: Infra setup
  tags:
    - setup
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - mkdir -p $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}
    - rsync -az --delete ${CI_PROJECT_DIR}/ ${GOPATH}/src/github.com/${REPONAME}/${IMAGENAME}/ #CI_PROJECT_DIR is full path where project is cloned
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test install-litmus_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

  
Build OpenEBS:
  
  when: always
  stage: Infra setup
  tags:
    - setup
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - mkdir -p $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}
    - rsync -az --delete ${CI_PROJECT_DIR}/ ${GOPATH}/src/github.com/${REPONAME}/${IMAGENAME}/ #CI_PROJECT_DIR is full path where project is cloned
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-setup_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

App Deploy:

  when: always
  stage: Infra setup
  tags:
    - setup
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - mkdir -p $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}
    - rsync -az --delete ${CI_PROJECT_DIR}/ ${GOPATH}/src/github.com/${REPONAME}/${IMAGENAME}/ #CI_PROJECT_DIR is full path where project is cloned
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test app-deploy_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

OpenEBS Target Pod Failure:
  
  when: always
  stage: experiment
  tags:
    - experiment
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-target-pod-failure_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

OpenEBS Pool Container Failure:
  
  when: always
  stage: experiment
  tags:
    - experiment
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-pool-container-failure_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

OpenEBS Pool Pod Failure:
  
  when: always
  stage: experiment
  tags:
    - experiment
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-pool-pod-failure_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

OpenEBS Target Container Failure:
  
  when: always
  stage: experiment
  tags:
    - experiment
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-target-container-failure_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

OpenEBS Target Network Delay:
  
  when: always
  stage: experiment
  tags:
    - experiment
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-target-network-delay_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

OpenEBS Target Network Loss:
  
  when: always
  stage: experiment
  tags:
    - experiment
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-target-network-loss_test.go -v -count=1

  artifacts:
    when: always
    paths:
      - .kube/

Application Cleanup:
  
  when: always
  stage: Infra cleanup
  tags:
    - cleanup
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test app-cleanup_test.go -v -count=1
    
  artifacts:
    when: always
    paths:
      - .kube/

Litmus Cleanup:
  
  when: always
  stage: Infra cleanup
  tags:
    - cleanup
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test litmus-cleanup_test.go -v -count=1
    
  artifacts:
    when: always
    paths:
      - .kube/
    

OpenEBS Cleanup:
  
  when: always
  stage: Infra cleanup
  tags:
    - cleanup
  script:

    - export GOPATH=$HOME/go
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - cd $HOME/go/src/github.com/${REPONAME}/${IMAGENAME}/tests/bdds
    - go test openebs-cleanup_test.go -v -count=1
    
  artifacts:
    when: always
    paths:
      - .kube/

Cluster Cleanup:

  when: always
  stage: cluster cleanup
  tags:
    - cleanup
  script: 
    - chmod 755 ./build/gitlab/stages/2-gke-cleanup/cluster-cleanup
    - ./build/gitlab/stages/2-gke-cleanup/cluster-cleanup

  artifacts:
    when: always
    paths:
      - .kube/