- hosts: localhost
  vars:
    a_ns: litmus
    a_kind: deployment
    name: engine-nginx1
    a_label: run=nginx
    e_name: pod-delete

  tasks: 
       
    - name: Get the resourceVersion of the target deploy before chaos injection
      shell: >
        kubectl get deployment nginx
        -n {{ a_ns }} -o=jsonpath='{.metadata.resourceVersion}'
      args:
        executable: /bin/bash
      register: rv_bef   

    - name: Installing pod-delete Experiment
      shell: kubectl create -f https://hub.litmuschaos.io/api/chaos?file=charts/generic/pod-delete/experiment.yaml -n {{ a_ns}}

    - template:
        src: ../../utils/chaosengine.j2
        dest: ../../utils/chaosengine.yml

    - name: Create chaos-engine
      shell: kubectl create -f ../../utils/chaosengine.yml

    - name: Waiting for the chaos complition
      shell: kubectl get po {{ name }}-runner -n {{ a_ns }} -o custom-columns=:.status.phase --no-headers
      register: result
      until: "'Succeeded' in result.stdout"
      delay: 10
      retries: 60      

    - name: Checking the verdict of the experiment 
      shell: kubectl get chaosresult {{ name }}-{{ e_name }} -n {{ a_ns }} -o jsonpath='{.spec.experimentstatus.verdict}'
      register: cr

    - name: Result of verdict test
      fail:
        msg: "Verdict is not pass"
      when: "cr.stdout != 'pass'"

    - name: Verify that the AUT (Application Under Test) is running
      include_tasks: "../../utils/status_app_pod.yml"
      vars:
        delay: 2
        retries: 60

    - name: Get the resourceVersion of the target deploy after fault injection
      shell: >
        kubectl get deployment nginx
        -n {{ a_ns }} -o=jsonpath='{.metadata.resourceVersion}'
      args:
        executable: /bin/bash
      register: rv_aft

    - name: Result of Version test
      fail:
        msg: "Resource Verison does not match"
      when: "rv_bef.stdout == rv_aft.stdout"
