- hosts: localhost
  vars:
    a_ns: litmus
    a_kind: deployment
    name: engine-nginx8
    a_label: run=nginx
    e_name: node-drain
    service_acc: node-drain-sa


  tasks: 

    - name: Fetching rbac for node-drain
      shell: wget -O {{ e_name }}-sa.yaml https://raw.githubusercontent.com/litmuschaos/chaos-charts/master/charts/generic/node-drain/rbac.yaml 
      args:
        executable: /bin/bash

    - name: Replace the namespace field in rbac
      shell: sed -i 's#namespace{{ ":" }} default#namespace{{ ":" }} litmus#g' {{ e_name }}-sa.yaml
      args:
        executable: /bin/bash

    - name: Creating rbac for {{ e_name }} experiment
      shell: kubectl apply -f {{ e_name }}-sa.yaml 
      args:
        executable: /bin/bash

    - name: Select a random node name of nginx deployment replicas
      shell: kubectl get po -n {{ a_ns }} -l {{ a_label }} -o jsonpath='{.items[0].spec.nodeName}'
      args:
        executable: /bin/bash
      register: app_node

    - set_fact:
        app_node: "{{ app_node.stdout }}"

    - name: Cordoning the node 
      shell: kubectl cordon "{{ app_node }}"
      args:
        executable: /bin/bash

    - name: Installing node-drain Experiment
      shell: kubectl apply -f https://hub.litmuschaos.io/api/chaos?file=charts/generic/node-drain/experiment.yaml -n {{ a_ns }}
      args:
        executable: /bin/bash

    - template:
        src: ../../utils/chaosengine.j2
        dest: ../../utils/chaosengine.yml

    - name: apply chaos-engine
      shell: kubectl apply -f ../../utils/chaosengine.yml
      args:
        executable: /bin/bash

    - name: Waiting for the chaos complition
      shell: kubectl get po {{ name }}-runner -n {{ a_ns }} -o custom-columns=:.status.phase --no-headers
      register: result
      args:
        executable: /bin/bash
      until: "'Succeeded' in result.stdout"
      delay: 10
      retries: 50

    - name: Checking the verdict of the experiment 
      shell: kubectl get chaosresult {{ name }}-{{ e_name }} -n {{ a_ns }} -o jsonpath='{.spec.experimentstatus.verdict}'
      args:
        executable: /bin/bash
      register: cr

    - name: Uncordoning the node
      shell: kubectl uncordon "{{ app_node }}"
      args:
        executable: /bin/bash

    - name: Result of verdict test
      fail:
        msg: "Verdict is not pass"
      when: "cr.stdout != 'pass' and cr.stdout != 'Pass'"

    - name: Verify that the AUT (Application Under Test) is running
      include_tasks: "../../utils/status_app_pod.yml"
      vars:
        delay: 2
        retries: 60


